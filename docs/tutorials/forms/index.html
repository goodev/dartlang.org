<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Product" xmlns:wb="http://open.weibo.com/wb">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>从表单中获取数据 | Dart: 用于创建结构化的web应用</title>
  <meta property="wb:webmaster" content="a984f6440858ee44" />
  <meta property="twitter:account_id" content="376585411" />
  <meta itemprop="name" content="从表单中获取数据 | Dart: 用于创建结构化的web应用">
  
  <meta itemprop="image" content="https://www.dartlang.org/imgs/dart-logo-wordmark-1200w.png">
  
  <meta itemprop="description" content="使用 HTML 表单和 input 元素往服务器发送数据">


  <link rel='stylesheet' type='text/css' href='/css/bootstrap.min.css'>
<link rel='stylesheet' type='text/css' href='/css/dart-style.css'>
<link rel='stylesheet' type='text/css' href='/css/prettify.css'>
<link rel='stylesheet' type='text/css' href='/css/font-awesome.min.css'>

  
    <link href="//fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:300,400" rel="stylesheet">

	
	
	
	<link rel="alternate" type="application/atom+xml" href="http://dartnews.sinaapp.com/?feed=atom" title="Atom feed">
  <!-- 
  <link href="https://plus.google.com/109866369054280216564" rel="publisher">
  -->
  <link href="http://weibo.com/cndart" rel="publisher">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
  <![endif]-->

  <!-- 
<script type="text/javascript">

  //var _gaq = _gaq || [];
 // _gaq.push(['_setAccount', 'UA-26406144-4']);
  //_gaq.push(['_setDomainName', 'dartlang.org']);
  //_gaq.push(['_setSiteSpeedSampleRate', 50]);
  //_gaq.push(['_trackPageview']);

 // (function() {
   // var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   // var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 // })();

</script>
-->


  <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
</head>
<body onload="prettyPrint()">
    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><i class="sprite-icon-dart-logo"></i></a>
        </div>

        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
           <li class="dropdown">
              <a href="/codelabs/darrrt/" title="Learn Dart in this short code lab.">
                                                       入门
              </a>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                文档 <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/tutorials/">教程</a></li>
                
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/dart-by-example/">Dart 示例</a></li>
                
                <li class="divider"></li>
                <li><a href="/docs/">开发者指南</a></li>
                <li><a href="http://api.dartlang.org">API 参考</a></li>
                <li><a href="/docs/spec/">语言规范</a></li>

                <li class="divider"></li>
                <li><a href="/docs/dart-up-and-running/">Dart: Up and Running</a></li>
                <li><a href="/books/">更多图书</a></li>

                <li class="divider"></li>
                <li><a href="/articles/">文章</a></li>
                <li><a href="/support/faq.html">FAQ</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                       工具  <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/dart-up-and-running/contents/ch04-tools-dart2js.html">dart2js</a>
                </li><li><a href="/tools/editor/">Dart Editor</a></li>
                <li><a href="http://pub.dartlang.cc/">Pub Package Manager</a></li>
                <li><a href="/tools/">更多工具</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                     资源  <span class="caret"></span>
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/samples/">示例代码</a></li>
                <li><a href="/docs/synonyms/">和其他语言的相同点</a></li>

                <li class="divider"></li>
                <li><a href="/slides/">演示文稿</a></li>
                <li><a href="/dart-tips/">Dart 短视频</a></li>

                <li class="divider"></li>
                <li><a href="/performance/">性能</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="/support/" title="Community and Support">
                                              支持
              </a>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li>
              <form class="navbar-search" action="/search.html" id="cse-search-box">
                <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
                <input type="hidden" name="ie" value="UTF-8">
                <input type="hidden" name="hl" value="en">
                <input type="search" name="q" class="search-query placeholder-position-fix form-control" id="q" autocomplete="off" placeholder="Search">
              </form>
            </li>
            <li><a target="_blank" href="https://twitter.com/dart_lang" class="btn"><i class="sprite-icon-social-twitter"></i></a></li>
            <li><a target="_blank" href="https://plus.google.com/+dartlang/posts" class="btn"><i class="sprite-icon-social-gplus"></i></a></li>
            <li><a target="_blank" href="http://weibo.com/cndart" class="btn"><i class="sprite-icon-social-weibo"><img src="/imgs/weibo.png"></i></a></li>
          </ul>
        </div><!-- /.nav-collapse -->

      </div><!-- /.container -->
    </div><!-- /.navbar -->

  


<div class="container-page">
  <div class="container">
    <div class="container col-md-12 col-md-offset-0 sub-page">
      <div class="has-permalinks">
      
<!-- NAVI LINKS -->
<div id="tutorial-navigation-links-top" class="row">
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-3">
        <a href="/docs/tutorials/"><img src="/docs/tutorials/images/tute-home.png" width="36" /></a>
      </div>
      <div class="col-md-3">
        <a href="/docs/tutorials/fetchdata/"><i class="glyphicon glyphicon-chevron-left"> </i> 动态获取数据</a>
      </div>
      <div class="col-md-3">
      </div>
      <div class="col-md-3">
        <a href="/docs/tutorials/indexeddb/" class="pull-right">使用 IndexedDB <i class="glyphicon glyphicon-chevron-right"> </i> </a>
      </div>
    </div> 
    <hr />
  </div> 
</div>

<!-- PAGE -->
<div class="row">

  <!-- LEFT SIDE BAR -->
  <div class="col-md-3">

    <div id="tutorial-side">
      <div id="whats-the-point">
        <h4 id="page-highlights">内容摘要</h4>
        
<ul>
  <li>用表单和 input 元素收集用户数据。</li>
  <li>通过声明的方式或者编码的方式把数据发送到服务器。</li>
  <li>用 HttpRequest 从服务器获取数据。</li>
  <li>用 Future 来处理异步通讯。</li>
  <li>用 HttpServer 设置一个服务器来监听具体的主机和端口。</li>
  <li>用 CORS 请求头来设置每个请求的访问权限。</li>
  <li>用 Polymer 数据绑定来同步表单数据和 Dart 数据。</li>
</ul>


      </div> <!-- whats-the-point -->

      <div id="code-links">
        <h4 id="examples">示例</h4>

        
<p> 该教程使用如下应用：</p>
<ul>
  <li>search_form</li>
  <li>slambook</li>
</ul>

<p>
如果还没有示例代码，可以
<a href="https://github.com/dart-lang/dart-tutorials-samples/archive/master.zip">
  下载代码。
</a>

</p>


        <a href="https://drone.io/github.com/dart-lang/dart-tutorials-samples/latest">
           <img src="https://drone.io/github.com/dart-lang/dart-tutorials-samples/status.png" alt="Build Status" style="margin-top:10px;max-width:100%;" />
        </a>
      </div> <!-- end code-links -->

      <div id="tutorial-toc">
        <a href="http://code.google.com/p/dart/issues/entry?template=Tutorial%20feedback" target="_blank">
        <i class="glyphicon glyphicon-comment"> </i>
        发送反馈
        </a>
      </div> <!-- tutorial-toc -->
      
    </div> <!-- tutorial-side -->

  </div> <!-- end div col-md-3 -->

  <!-- CONTENT-->
  <article class="col-md-9 tutorial-content">

    
<div class="tute-target-title">
<h1>从表单中获取数据</h1>
<h3>用表单从用户获取数据。</h3>
</div>

<p>很多 web 应用依赖表单来收集数据，然后
把数据发送到服务器。
一个表单通常包含多个输入元素
来收集各种类型的数据，例如
名字和地址、生日、Emai 地址
 等等。
HTML 支持几种输入元素，
有 text fields、 text areas、 radio buttons、 和 checkboxes。
HTML5 添加了一些具体的输入元素，例如
 email 和 password fields、
color pickers、 date and time widgets、以及 range elements。</p>

<p>该示例包含了一个客户端和一个服务器。
客户端用 Polymer 来显示用户界面
（一个包含了多个输入元素的表单）并
和 Dart 数据同步。
使用 Dart core 库的几个类实现 客户端
和服务器的通信， 
这些类有 streams、Futures、HttpRequest 等。
服务器用 CORS 允许跨站点请求。</p>

<aside class="alert alert-info">
  <p><strong>注意：</strong>
  该教材假设你已经学习了
  <a href="/docs/tutorials/polymer-intro/">定义自定义元素</a>、
  <a href="/docs/tutorials/futures/">使用 Future-Based APIs</a>
  和 <a href="/docs/tutorials/fetchdata/">动态获取数据</a>，
  或者熟悉 Polymer、 Futures、JSON、 和 HttpRequest 。</p>
</aside>

<ul>
  <li><a href="#about-forms">关于表单</a></li>
  <li><a href="#about-the-slambook-example">关于 slambook 示例</a></li>
  <li><a href="#submitting-a-form">提交一个表单</a></li>
  <li><a href="#resetting-a-form">重置一个表单</a></li>
  <li><a href="#creating-a-server">创建一个服务器并监听一个端口</a></li>
  <li><a href="#handling-options-requests">处理 OPTIONS 请求</a></li>
  <li><a href="#setting-cors-headers">设置 CORS 请求头</a></li>
  <li><a href="#handling-post-requests">处理 POST 请求</a></li>
  <li><a href="#recipe">客户端-服务器 web 应用的秘方</a></li>
  <li><a href="#binding-data">Polymer 中的双向数据绑定</a></li>
  <li><a href="#other-resources">其他资源</a></li>
  <li><a href="#what-next">接下来干啥？</a></li>
</ul>

<h2 id="about-forms">关于表单</h2>

<p>一个表单通常有一个 <em>action</em> 和 一个 <em>method</em> 属性分别
指定了发送数据的 URL 和 发送数据的方式。
action 和 method 可以在 HTML 代码中指定，也可以
在 Dart 代码设置或者用 Dart 库
来动态的执行 action。</p>

<p>下面从一个基本的表单来
学习下 actioin、method、和 input 元素以及表单的默认行为。
下面的表单用 Google 来搜索
&lt;form&gt; 标签中的内容，
如果 checkbox 选中则搜索 dartlang.org 的内容
如果 没有选中则搜索网络内容。
该示例为 <code>search_form</code>， 
默认用 “Cookbook” 搜索
<a href="http://www.dartlang.org">dartlang.org</a>
内容。</p>

<iframe class="running-app-frame" style="height:100px;width:500px;" src="examples/search_form/web/search_form.html">
</iframe>

<p>下面是创建上面表单的代码：</p>

<pre class="prettyprint lang-html">&lt;form action=&quot;http://www.google.com/search&quot;
      method=&quot;GET&quot;
      target=&quot;_blank&quot;&gt;
  ...
&lt;/form&gt;</pre>

<p>关注下 <code>action</code> 和 <code>method</code> 属性：</p>

<table class="table">
  <thead>
    <tr>
      <th>属性</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>action</td>
      <td>URL 指定了发送数据的地址。 这里为 Google 搜索，当点击按钮的时候 输入框的内容会附加到 URL 中。</td>
    </tr>
    <tr>
      <td>method</td>
      <td>指定了如何发送数据。通常用 GET 来请求数据资源，而 POST 来往服务器提交数据。</td>
    </tr>
  </tbody>
</table>

<p>下面是表单中三个 input 元素的代码，
一个文本输入框、一个提交按钮和一个 checkbox：</p>

<pre class="prettyprint lang-html">&lt;input   type=&quot;text&quot;     name=&quot;q&quot;
                         value=&quot;Cookbook&quot; size=&quot;31&quot; maxlength=&quot;255&quot;&gt;
&lt;input   type=&quot;submit&quot;   value=&quot;Google Search&quot;&gt;
&lt;label&gt;
  &lt;input type=&quot;checkbox&quot; name=&quot;sitesearch&quot;
                         value=&quot;dartlang.org&quot; checked&gt; Search dartlang.org&lt;br&gt;
&lt;/label&gt;</pre>

<p>checkbox 用一个 label 标签包围着，
这样你可以通过点击 checkbox 或者
 label 文本来选中 checkbox。</p>

<p>该 HTML 代码默认提供了一些行为：</p>

<dl>
  <dt> &lt;input type="submit" ...&gt; </dt>
  <dd> 创建一个特殊的按钮，
  当点击该按钮的时候收集表单中的数据。
  根据 action 和 method 属性 来组成请求
   URL 地址并提交
  数据到该 URL 地址。
  </dd>
  <dt> name="q" </dt>
  <dt> name="sitesearch" </dt>
  <dd>
    <p>指定输入框和 checkbox 的名字。</p>

    <p>在表单中，
  input 元素的 name 设置了表单数据的名字。
  在该示例中，输入框的文本值为 <code>q</code> 的值，而 checkbox 的值
  用于 <code>sitesearch</code>，这两个都是 
  合法的 Google 搜索 URL 的组成部分。
  当用户点击提交按钮的时候，
  名字和输入的值将附加到 
  搜索 URL 的后面提交。
  例如：</p>

    <pre class="prettyprint">http://www.google.com/search?q=Cookbook&amp;sitesearch=dartlang.org</pre>
  </dd>

</dl>

<p>上面的代码只是通过 HTML 实现，没用 Dart 或者 JavaScript。
由于该实例比较简单，用 HTML 表单
的默认行为
就够了。
对于保护了大量数据的表单，
或者需要和特殊的服务器通信的 web 应用，
你通常需要通过代码来处理表单。</p>

<p>下面的示例在代码中用 POST 请求
来发送复杂的表单数据到服务器。</p>

<h2 id="about-the-slambook-example">关于 slambook 示例</h2>

<p>该示例包含两个程序。</p>

<ul>
  <li>
    <p>首选，
是一个名字为 <code>slambookserver</code> 的服务器程序，
该程序监听 4040 端口并处理 
POST 和 OPTIONS 请求，
把客户端发送的消息打印出来并返回一个确认消息。
服务器用 CORS 请求头来
允许来自于不同源的请求。</p>
  </li>
  <li>
    <p>然后，
一个名字为 <code>slambook</code> 的
客户端程序，
提供了一个可以输入各种信息的表单。
用 Polymer 双向数据绑定来绑定 input 元素和 Dart 变量。
当用户点击提交按钮的时候，
Dart 代码把输入数据格式化为 JSON 字符串，
发送一个 OPTIONS 请求获取服务器的许可，
然后用一个 POST 请求发送数据。
当客户端收到服务器的响应后，
显示出来返回的结果。</p>
  </li>
</ul>

<p>下图显示了
客户端和服务器通信的流程。</p>
<hr />

<p><img class="scale-img-max" src="images/client-server-comm.png" alt="Client-server communication in the slambook example" /></p>

<hr />

<p><strong>动手试试！</strong>
输入一些数据，然后点击 <strong>Submit</strong> 按钮。</p>

<iframe class="running-app-frame" style="height:500px;width:525px;" src="examples/slambook/out/web/slambook.html">
</iframe>

<aside class="alert">
<strong>版本提示：</strong>  slambook 应用和 
<a href="https://pub.dartlang.org/packages/polymer#versions">polymer.dart 0.9</a>
 版本兼容。
</aside>

<p>由于你还没在你的电脑上运行服务器端程序，所有
点击提交按钮你会发现显示的结果为 “No server”。
下面来运行服务器。</p>

<h3 id="section">运行服务器</h3>

<p>从
<a href="https://github.com/dart-lang/dart-tutorials-samples/archive/master.zip">
 教程实例
</a>
中下载
该服务器的代码，
名字为 slambookserver.dart 。</p>

<p>从命令行运行该代码：</p>

<pre class="prettyprint">% dart slambookserver.dart
Listening for GET and POST on http://127.0.0.1:4040</pre>

<p>现在，可以用上面的应用再次提交数据了。</p>

<aside class="alert">
注意：如果已经有服务器在监听 localhost 4040 端口了，
该代码打印一个错误信息然后退出。
该示例需要 slambookserver 在 localhost 4040 端口，
如有必要，你需要停止其他软件并再次启动  slambookserver。
另外，你也可以修改该示例的 客户端和服务器端代码中使用的端口。
</aside>

<p>下面的内容解释该示例的服务器端和客户端代码如何实现的。</p>

<p>在客户端可以学习如下内容：</p>

<ul>
  <li>提交表单</li>
  <li>重置表单</li>
  <li>用 Polymer 来绑定表单数据到 Dart 变量。</li>
</ul>

<p>在服务器端可以学习如下内容：</p>

<ul>
  <li>CORS headers</li>
  <li>处理 OPTIONS 请求</li>
  <li>处理 POST 请求</li>
</ul>

<h2 id="section-1">提交一个表单</h2>

<p>先来看看数据是如何提交到服务器的。</p>

<p>在一开始的 search_form 示例中依赖 <code>action</code> 和
<code>method</code>属性的默认行为来指定
提交的方式
和地址。
而在 slambook 示例中，
通过代码来
控制提交的过程。</p>

<ul>
  <li>首先，表单没有设置 action 和 method。</li>
  <li>然后，提交按钮有个 Dart 点击事件监听器。</li>
  <li>第三， Dart 点击事件监听器阻止
默认的提交数据行为。</li>
  <li>最后，用 Dart 库提供的功能把表单数据提交
到服务器。</li>
</ul>

<p>slambook 示例中的表单是
一个名字为 <code>tute-slambook-form</code> 的
自定义元素，通过如下代码初始化：</p>

<pre class="prettyprint lang-html">&lt;div class=&quot;container&quot;&gt;
  &lt;form is=&quot;tute-slambook-form&quot; id=&quot;slambookform&quot;&gt;&lt;/form&gt;
&lt;/div&gt;</pre>

<p>上面的表单中，既没有 <code>action</code> 也没有 <code>method</code> 属性。
提交按钮的行为用 Dart 鼠标点击事件来
处理。
下面是创建提交按钮的 HTML 代码并
绑定了一个 Dart 鼠标点击监听器。</p>

<pre class="prettyprint lang-html">&lt;div class=&quot;submitarea&quot;&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Submit&quot; on-click=&quot;{{submitForm}}&quot;&gt;
  ...
&lt;/div&gt;</pre>

<p>下面是鼠标点击监听器 submitForm() 函数的代码：</p>

<p><img class="scale-img-max" src="images/post-request.png" alt="Making a post request" /></p>

<p>下面来逐步分析下来监听器代码。</p>

<h3 id="section-2">阻止默认行为</h3>

<p>即使没有 <code>action</code> 和 <code>method</code> 属性，
提交按钮也有默认行为，
该默认行为在 slambook 示例中是没用的。
所有首先需要在代码中调用函数 
<code>e.preventDefault()</code> 来
阻止默认行为。</p>

<pre class="prettyprint lang-dart">void submitForm(Event e) {
  e.preventDefault(); // Don't do the default submit.
  ...
}</pre>

<h3 id="post-">设置并触发 POST 请求</h3>

<p>然后，代码创建了一个
<a href="https://api.dartlang.org/dart_html/HttpRequest.html" target="_blank">HttpRequest</a>
对象。
代码中用  <code>new</code>  来创建 HttpRequest 对象，
然后配置一些参数。
HttpRequest 类有个获取 GET 请求返还结果
为字符串的函数 HttpRequest。</p>

<p>然后代码在 HttpRequest 对象中设置了一个回调函数 <code>onData</code>，
该函数
在接受到服务器响应的时候触发。
在后面讲会介绍 onData() 函数的实现。</p>

<p><strong>重要：</strong>
在开始请求之前必须设置
回调函数!</p>

<pre class="prettyprint lang-dart">request = new HttpRequest();
request.onReadyStateChange.listen(onData);

var url = 'http://127.0.0.1:4040';
request.open('POST', url);
request.send(slambookAsJsonData());</pre>

<p>然后，代码筒指定
的 URL 和端口参数来
发出一个 POST 请求。</p>

<p>最后的代码把 JSON 字符串发送到服务器。
有时，数据位字节流。
但是该示例中的数据比较短可以一次发送完毕。
该请求是异步的，
所有 send() 函数很快就返回了。</p>

<h3 id="section-3">监听服务器应答</h3>

<p>HttpRequest 对象负责和服务器通信。
通过 HttpRequest 对象的 <code>readyState</code> 变量
可以获取通信的状态。
readyState 有五种可能的值：
unsent（未发送）、 opened（已建立连接）、 headers received（收到响应头）、 loading（正在接受结果）、 和 done（请求完成）。
当 readyState 改变的时候，HttpRequest 会触发事件，然后会调用
 onData() 回调函数。</p>

<p>注意在 <code>onReadyStateChange</code> 注册
的回调函数 onData。</p>

<pre class="prettyprint lang-dart">request.onReadyStateChange.listen(onData);</pre>

<p>listen() 函数只需要一个签名
为 <em>void onData(T)</em> 的回调函数即可。
listen() 函数还有三个可选的参数，
例如 一个错误处理函数。</p>

<p>onData() 回调函数功能比较简单：</p>

<pre class="prettyprint lang-dart">void onData(_) {
  if (request.readyState == HttpRequest.DONE &amp;&amp;
      request.status == 200) {
    // Data saved OK.
    serverResponse = 'Server Sez: ' + request.responseText;
  } else if (request.readyState == HttpRequest.DONE &amp;&amp;
      request.status == 0) {
    // Status is 0...most likely the server isn't running.
    serverResponse = 'No server';
  }
}</pre>

<p>首先检查请求是否成功完成了。
如果完成了，代码显示服务器返回的结果 （保存在 <code>serverResponse</code> 变量中），
该变量和 UI 中的文本输入框绑定在一起，
当该变量值发生变化的时候，
UI 会自动更新然后
服务器返回的值就显示出来了。</p>

<p>如果，请求完成了，但是出错了，
代码设置 <code>serverResponse</code> 值为一个错误信息，
然后显示给用户。</p>

<h2 id="section-4">重置一个表单</h2>

<p>reset 按钮是特殊的 HTML input 类型，默认情况下该
按钮清空所有表单中的数据。
该示例中，我们想让该按钮设置表单的数据为
初始值。
所有我们注册了一个鼠标点击事件来
阻止默认行为并
重置表单数据为默认数据。</p>

<pre class="prettyprint lang-dart">void resetForm(Event e) {
  e.preventDefault();
  favoriteThings['kittens'] = false;
  favoriteThings['raindrops'] = false;
  favoriteThings['mittens'] = false;
  favoriteThings['kettles'] = false;

  theData['firstName'] = '';
  theData['favoriteQuote'] = '';
  theData['favoriteColor'] = '#FFFFFF';
  theData['birthday'] = '2013-01-01';
  theData['volume'] = '0';
  theData['catOrDog'] = 'cat';
  theData['music'] = 0;
  theData['zombies'] = false;
  serverResponse = &quot;Data reset.&quot;;
}</pre>

<h2 id="creating-a-server">创建一个服务器并监听一个端口</h2>

<p>下面来看看响应 HTTP 请求
的 <code>slambookserver</code> 服务器程序。
该服务器代码基于
 Chris Buckett 写的
<a href="/articles/json-web-service/">使用 Dart 的 JSON Web 服务</a> 一文中的实现。</p>

<p>该服务器监听 4040 端口并且只
响应 POST 和 OPTIONS 请求。
在该两种类型请求中，
服务器都添加一个 CORS 请求头信息。
对于 POST 请求，
服务器返回一个简短的确认信息
来表明服务器收到了客户端发送的 JSON 数据。</p>

<p>来看看具体的代码。</p>

<p>下面是 slambookserver 的 main() 入口函数。
使用 
<a href="https://api.dartlang.org/dart_io/HttpServer.html" target="_blank">HttpServer</a>
 类的 bind() 函数
 来监听本机的 4040 端口，</p>

<pre class="prettyprint lang-dart">final HOST = '127.0.0.1';
final PORT = 4040;

void main() {
  HttpServer.bind(HOST, PORT).then(gotMessage, onError: printError);
}</pre>

<p>bind() 函数返回一个 Future 对象，
Future 对象是从未来获取数据的一种方式。
通过 then() 函数，
代码在 Future 上注册了两个回调函数。
第一个函数 gotMessage() 在 Future 返回它的值的时候调用。
第二个函数 <code>printError</code> 在绑定端口出错的情况调用。
如果一个程序已经占用
了 4040 端口则就会发生错误。</p>

<p>for gotMessage() 的代码过滤
请求并根据请求类型调用不同的函数来处理每个请求。</p>

<pre class="prettyprint lang-dart">void gotMessage(_server) {
  _server.listen((HttpRequest request) {
    switch (request.method) {
      case 'POST': 
        handlePost(request);
        break;
      case 'OPTIONS': 
        handleOptions(request);
        break;
      default: defaultHandler(request);
    }
  },
  onError: printError); // Listen failed.
  print('Listening for GET and POST on http://$HOST:$PORT');
}</pre>

<p>要处理其他的请求类型，
例如 <code>GET</code> 请求，只需要
在 case 语句中添加一个 
<code>case 'GET'</code> 即可。</p>

<h3 id="future-">关于 Future 的简单介绍</h3>

<p>在查看如何处理 OPTIONS 和 POST 请求之前先来
看看 Future 的介绍。</p>

<p>一个 
<a href="https://api.dartlang.org/dart_async/Future.html" target="_blank">Future</a>
 是从未来获取数据的一种方式。
使用 Future 来避免阻塞程序，
例如 如果请求的数据需要比较长时间的计算，
或者 需要访问磁盘 IO 操作。</p>

<p>当一个返回 Future 的函数被调用时，
会发生两种情况：</p>

<ul>
  <li>
  该函数保存到队列中，然后
  立刻返回一个未完成的 Future 对象。
  </li>
  <li>
  以后，当数据可用的时候，
  Future 对象使用数据或者错误信息来完成该操作。
  </li>
</ul>

<p>要获取 Future 代表的数据，
需要用 then() 函数注册一个回调函数。
当 Future 完成的时候，会
调用该函数。</p>

<p>在该示例中，
服务器和客户端都使用 Future 来发送
请求和响应事件。
客户端-服务器程序应该总是使用
 Future 来异步的处理通信和其他 IO 操作。</p>

<h2 id="options-">处理 OPTIONS 请求</h2>

<p>slambook 客户端用 
<a href="https://api.dartlang.org/dart_html/HttpRequest.html" target="_blank">HttpRequest</a>
类
来
提交 POST 请求。</p>

<p>在 web 应用中，
通常客户端和服务器都
运行在不同的源中，在该情况下的 POST 请求为 “preflighted”。
一个 “preflighted” 请求必须先发送一个 OPTIONS 请求
来判断该请求是否允许提交。
HttpRequest 类自动处理 
preflight OPTIONS 请求。
而无需你手动处理。</p>

<p>服务器先获取 OPTIONS 请求。
下面是 slambookserver 服务器处理 OPTIONS 请求的代码。</p>

<pre class="prettyprint lang-dart">void handleOptions(HttpRequest req) {
  HttpResponse res = req.response;
  addCorsHeaders(res);
  print('${req.method}: ${req.uri.path}');
  res.statusCode = HttpStatus.NO_CONTENT;
  res.close();
}</pre>

<p>代码比较简单明了：</p>

<ul>
  <li>获取 
<a href="https://api.dartlang.org/dart_io/HttpResponse.html" target="_blank">HttpResponse</a>
 对象，该对象代表服务器返回客户端的内容。</li>
  <li>添加访问控制的 CORS 请求头</li>
  <li>在控制台打印消息</li>
  <li>标注该响应没有内容</li>
  <li>关闭响应，并发送应答到客户端。</li>
</ul>

<p>当客户端收到应答后，
里面的 CORS 请求头表明可以发送 POST 请求。</p>

<h2 id="cors-">设置 CORS 请求头</h2>

<p>服务器用如下代码来添加 CORS 请求头
信息到 OPTIONS 和 POST 请求中。
该函数在服务器应答中
（<a href="https://api.dartlang.org/dart_html/HttpRequest.html" target="_blank">HttpResponse</a>）
   添加了
三个访问控制（Access-Control）请求头信息。</p>

<pre class="prettyprint lang-dart">void addCorsHeaders(HttpResponse res) {
  res.headers.add('Access-Control-Allow-Origin', '*, ');
  res.headers.add('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.headers.add('Access-Control-Allow-Headers',
      'Origin, X-Requested-With, Content-Type, Accept');
}</pre>

<p>前两个 CORS 请求头允许来自任意
地方的 POST 和 OPTIONS 请求。
第三个指定了服务器接受
的 POST 和 OPTIONS 请
求头信息。</p>

<p>关于 CORS 的详细信息请参考：</p>

<ul>
  <li><a href="https://www.html5rocks.com/en/tutorials/cors/">使用 CORS</a></li>
</ul>

<h2 id="post--1">处理 POST 请求</h2>

<p>下面是处理客户端 HTTP POST 请求的函数：</p>

<pre class="prettyprint lang-dart">void handlePost(HttpRequest req) {
  HttpResponse res = req.response;
  print('${req.method}: ${req.uri.path}');
  
  addCorsHeaders(res);
  
  req.listen((List&lt;int&gt; buffer) {
    // Return the data back to the client.
    res.write('Thanks for the data. This is what I heard you say: ');
    res.write(new String.fromCharCodes(buffer));
    res.close();
  },
  onError: printError);
}</pre>

<p>和处理 OPTIONS 请求一样，
slambookserver 从 请求中获取 HTTP response 对象，
在控制台打印一个信息，
添加 CORS 信息到应答中。</p>

<p>然后监听来自
客户端 POST 请求的数据。
当 <em>所有</em> 的数据准备好后会
调用回调函数。
回调函数是一个函数字面字符串。
该函数的参数为一个装有
数字的 list。
每个数字都是一个字符代码，
其中每个代码可以为 UTF-16 格式代码。
你可以用 String.fromCharCodes() 函数
把字符代码转化为字符串。</p>

<p>HttpResponse 对象管理一个服务器用来向
客户端发送数据的数据流。
在数据回调函数中，
slambookserver 在数据流中写入一条消息
和收到的数据。
实际上的服务器可以通过不同方式处理该数据，
比如保存起来 等。</p>

<p>当关闭数据流的时候，HttpResponse 对象
把数据发送到客户端。</p>

<h2 id="recipe">客户端-服务器 web 应用的秘方</h2>

<p>slambook 客户端-服务器示例可以作为
你客户端服务器 web 应用的起点，或者
作为创建你自己程序的参考。</p>

<p>下面是客户端需要实现的一些功能：</p>

<ul>
  <li>用表单来收集用户数据。</li>
  <li>在表单中放置多少 input 元素来收集不同的数据。</li>
  <li>用 Polymer 中的双向数据绑定来同步表单和 Dart 代码中的数据。</li>
  <li>可以通过声明的方式 (在表单上定义 action 和 method 属性)</li>
  <li>… 或者通过代码 (在提交按钮上注册 Dart 函数)来发送数据</li>
  <li>从 HttpRequest 对象获取服务器应答数据。</li>
  <li>用 Future 对象来处理异步通信。</li>
</ul>

<p>下面是服务器端代码需要实现的一些功能：</p>

<ul>
  <li>用 HttpServer 来启动一个服务器。</li>
  <li>监听客户端请求。</li>
  <li>用 CORS 请求头来设置每个请求的跨站点访问控制。</li>
  <li>用 HttpResponse 来应答数据。</li>
  <li>用 Future 对象来处理异步通信。</li>
  <li>用数据流(Stream) 来写应答数据。</li>
</ul>

<p>在 Dart 核心库中有一些对客户端和服务器端
提供支持的类。
注意，分别有两个 HttpRequest 类，一个在 dart:html 包
中用于客户端，一个在 dart:io 包中 用于服务器。</p>

<table class="table">
  <thead>
    <tr>
      <th>资源</th>
      <th>库</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://api.dartlang.org/dart_html/HttpRequest.html" target="_blank">HttpRequest</a></td>
      <td>dart:html</td>
      <td>Client-side HTTP request</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_io/HttpRequest.html" target="_blank">HttpRequest</a></td>
      <td>dart:io</td>
      <td>Server-side HTTP request</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_io/HttpServer.html" target="_blank">HttpServer</a></td>
      <td>dart:io</td>
      <td>服务器端对象来处理和客户端的通信</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_io/HttpResponse.html" target="_blank">HttpResponse</a></td>
      <td>dart:io</td>
      <td>服务器端对象来响应客户端请求</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_async/Stream.html" target="_blank">Streams</a></td>
      <td>dart:async</td>
      <td>一个数据流</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_async/Future.html" target="_blank">Future</a></td>
      <td>dart:async</td>
      <td>异步获取数据的一种方式</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/dart_convert.html#JSON" target="_blank">JSON</a></td>
      <td>dart:convert</td>
      <td>JSON 转换器的默认实现</td>
    </tr>
    <tr>
      <td><a href="https://api.dartlang.org/polymer.html" target="_blank">Polymer</a></td>
      <td>Polymer</td>
      <td>自定义元素、数据绑定、模板</td>
    </tr>
  </tbody>
</table>

<h2 id="binding-data">Polymer 中的双向数据绑定</h2>

<p>slambook 示例用 Polymer 提供的双向数据绑定功能来
绑定 input 元素和 Dart 变量。
如果用户修改了 input 元素中的值，
Dart 中绑定的变量会自动更新。
或者 如果 Dart 代码修改了绑定变量的值，
则 UI 会自动更新。
<a href="/docs/tutorials/polymer-intro/">定义一个自定义元素</a>
简单介绍了自定义元素和
数据绑定。</p>

<p>该示例还用声明式事件处理 函数
来映射函数为 input 事件监听器。</p>

<p>在 slambook 示例中，
有多个 input 元素使用了双向数据绑定，
其中有一个新的 HTML5 元素。
下面表格介绍了 Polymer 中可用的双向数据绑定属性：</p>

<table class="table">
  <thead>
    <tr>
      <th>属性</th>
      <th>Dart 类型</th>
      <th>Input element</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>value</td>
      <td>String</td>
      <td>任意元素</td>
    </tr>
    <tr>
      <td>selectedIndex</td>
      <td>integer</td>
      <td>只允许选择一个元素的 &lt;select&gt;</td>
    </tr>
    <tr>
      <td>checked</td>
      <td>bool</td>
      <td>individual radio buttons 或者 checkboxes</td>
    </tr>
  </tbody>
</table>

<h3 id="input--value">在任意 input 元素中使用 value</h3>

<p><code>value</code> 属性支持任意 input 元素，
并且把元素 的值绑定到 Dart 字符串中。 
该示例中的 text field、text area、color picker、 data chooser 和
一个 range 元素都使用了 <code>value</code> 属性。</p>

<p><img class="scale-img-max" src="images/bind-value.png" alt="Two-way data binding with value and strings" /></p>

<p>(注意，上图中为了
阅读方便，一些装饰性的
代码给删除了。 )</p>

<p>在 Dart 代码中，一个名字为 <code>theData</code> 的 map 对象包含了
表单中的数据。 代码通过 <code>@observable</code> 注解和 <code>toObservable()</code> 函数
来绑定数据。</p>

<p>map 包含了每个 input 元素的 key-value 对， 其他 key 为
字符串。
用  <code>value</code> 绑定的元素都是 字符串。
HTML 代码通过 Dart 代码中的名字来访问
 map 中的数据。
例如， color picker （颜色选择控件） 的值绑定到
 <code>theData['favoriteColor']</code> 中。</p>

<h3 id="selectedindex">在下拉菜单中使用 selectedIndex</h3>

<p>一个 &lt;select&gt; 元素包含一个或者多少 &lt;option&gt; 元素，
默认一次只能选择其中的一个元素。
一次选择一个元素的 select 通常用下拉菜单实现。
你可以用 <code>selectedIndex</code> 属性来绑定 Dart 整数到
下拉菜单上。
该整数代表选中的元素索引。
索引从 0 开始。</p>

<p><img class="scale-img-max" src="images/bind-selected.png" alt="The selectedIndex attribute with a single-selection pull-down menu" /></p>

<h3 id="checkboxe--checked">在 checkboxe 中使用 checked</h3>

<p>用 <code>checked</code> 属性来绑定 Dart 布尔值到
只能选择一个的 checkbox 中。
下面每个 checkbox 绑定到 map 中的不同对象。</p>

<p><img class="scale-img-max" src="images/bind-checked.png" alt="The checked attribute with individual checkboxes" /></p>

<h2 id="section-5">其他资源</h2>

<ul>
  <li> 处理客户端和服务器端通信
  的代码基于 Chris Buckett 写
  的文章
       <a href="/articles/json-web-service/">使用 Dart 中的 JSON Web Services</a> 。
  </li>
  <li> 前一教程中，
       <a href="/docs/tutorials/fetchdata/">动态获取数据</a> 
       中介绍了如何使用 Dart 编辑器来实现一个
       从服务器获取 JSON 文件
       的客户端。
  </li>
</ul>

<h3 id="section-6">接下来干啥？</h3>

<p>下一个教程，
<a href="/docs/tutorials/indexeddb">使用 IndexedDB</a>
将介绍如何用浏览器的 Indexed Database（索引数据库）
来在客户端保存数据。</p>



  </article>
</div>

<!-- NAVI LINKS -->
<div id="tutorial-navigation-links-bottom" class="row">
  <div class="col-md-12">
    <hr />
    <div class="row">
      <div class="col-md-3">
        <a href="/docs/tutorials/"><img src="/docs/tutorials/images/tute-home.png" width="36" /></a>
      </div>
      <div class="col-md-3">
        <a href="/docs/tutorials/fetchdata/"><i class="glyphicon glyphicon-chevron-left"> </i> 动态获取数据</a>
      </div>
      <div class="col-md-3">
      </div>
      <div class="col-md-3">
        <a href="/docs/tutorials/indexeddb/" class="pull-right">使用 IndexedDB <i class="glyphicon glyphicon-chevron-right"> </i> </a>
      </div>
    </div> 
  </div> 
</div>


      </div>
    </div>
  </div>
</div>

  <footer class="footer container-full">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h3>一种用于创建可扩展 web 应用程序的语言、工具和代码库</h3>
          <p>Dart 是一个 <a href="https://code.google.com/p/dart/">开源项目</a>，由  Google 和其他人员参与。</p>
          <p class="sm">除非注明，该页面内容使用 the Creative Commons Attribution 3.0 License 发布，示例代码使用  BSD License 发布。</p>
          <!-- 
          <p><a class="saelogo" href="http://sae.sina.com.cn/activity/invite/15649/weibo" target="_blank"><img src="http://static.sae.sina.com.cn/image/poweredby/poweredby.png" title="Powered by Sina App Engine"></a></p>     	
          -->
        </div>
        <div class="col-md-2 col-md-offset-1">
          <h4>受欢迎的文章</h4>
          <ul>
            <li><a href="/polymer-dart/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Polymer.dart</a></li>
            <li><a href="/performance/">性能</a></li>
            <li><a href="/docs/dart-up-and-running/contents/ch02.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">语言概览</a> &amp;
            <a href="/docs/dart-up-and-running/contents/ch03.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码库概览</a></li>
            <li><a href="/samples/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">示例代码</a></li>
            <li><a href="/docs/tutorials/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">教程</a> &amp;
                <a href="/codelabs/darrrt/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码实验室</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>资源</h4>
          <ul>
            <li><a href="http://pub.dartlang.org/">Pub packages</a></li>
            <li><a href="/docs/synonyms/">和其他语言的相同点</a></li>
            <li><a href="http://code.google.com/p/dart/issues/list">Dart bugs and feature requests</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>社区</h4>
          <ul>
            <li><a href="/support/">邮件列表</a></li>
            <li><a href="http://forum.dartlang.cc">中文社区</a></li>
            <li><a href="http://weibo.com/cndart">中文微博</a></li>
            <li><a href="https://plus.google.com/communities/114566943291919232850">G+ 社区</a></li>
            <li><a href="https://plus.google.com/+dartlang/posts">G+ 新闻发布频道</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/dart">Stack Overflow</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer> <!-- End footer -->

<style>
#survey-prompt {
text-align: center;
position: fixed;
bottom: 0px;
left: 0px;
background: #00A4E4;
color: white;
font-size: 15px;
padding: 5px 70px;
z-index: 3000;
text-decoration: none;
border-radius: 0 5px 0 0;
}
</style>

<a href="//goo.gl/wpc0hL" target="_blank" id="survey-prompt">
填写一个两分钟开发者问卷调查。<br>
帮助 Dart 开发团队制定 2014 年度计划。
</a>

<script type='text/javascript' src='/js/jquery.js'></script>
<script type='text/javascript' src='/js/bootstrap.min.js'></script>
<script type='text/javascript' src='/js/prettify.js'></script>
<script type='text/javascript' src='/js/lang-dart.js'></script>
<script type='text/javascript' src='/js/lang-yaml.js'></script>
<script type='text/javascript' src='/js/scripts.js'></script>




<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F76b2695e71e6cec6e6af036d76afa367' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=slide&amp;img=1&amp;pos=left&amp;uid=590574" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
var bds_config={"bdTop":367};
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);
</script>
<!-- Baidu Button END -->
</body>
</html>

