<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Product">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>An Introduction to the dart:io Library | Dart: 结构化的web应用</title>
  <meta property="twitter:account_id" content="376585411" />
  <meta itemprop="name" content="An Introduction to the dart:io Library | Dart: 结构化的web应用">
  
  <meta itemprop="image" content="https://www.dartlang.org/imgs/dart-logo-900w.png">
  
  <meta itemprop="description" content="An introduction to the Dart I/O library, which is aimed at server-side code that runs on the standalone Dart VM.">

  <!-- Bootstrap core CSS -->
  <link href="/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/css/dart-style.css" rel="stylesheet">
  <link href="/css/prettify.css" type="text/css" rel="stylesheet" />
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
  <link href="//fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
	
	<link rel="author" href="/authors/mads-ager.html">
	
	<link rel="alternate" type="application/atom+xml" href="http://news.dartlang.org/feeds/posts/default" title="Atom feed">
  <link href="https://plus.google.com/109866369054280216564" rel="publisher">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
  <![endif]-->

  <!-- 
<script type="text/javascript">

  //var _gaq = _gaq || [];
 // _gaq.push(['_setAccount', 'UA-26406144-4']);
  //_gaq.push(['_setDomainName', 'dartlang.org']);
  //_gaq.push(['_setSiteSpeedSampleRate', 50]);
  //_gaq.push(['_trackPageview']);

 // (function() {
   // var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   // var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 // })();

</script>
-->
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F76b2695e71e6cec6e6af036d76afa367' type='text/javascript'%3E%3C/script%3E"));
</script>


  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script>
  

	window.___gcfg = {lang: 'en'};
	(function()
	{var po = document.createElement("script");
	po.type = "text/javascript"; po.async = true;po.src = "https://apis.google.com/js/plusone.js";
	var s = document.getElementsByTagName("script")[0];
	s.parentNode.insertBefore(po, s);
	})();
  </script>

  <script>
    window.twttr = (function (d,s,id) {
      var t, js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
      js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
      return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
    }(document, "script", "twitter-wjs"));
  </script>
</head>
<body onload="prettyPrint()">

    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><i class="sprite-icon-dart-logo"></i></a>
        </div>

        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
           <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                       入门
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/codelabs/darrrt/">试试 Dart</a></li>
                <li><a href="/docs/tutorials/">Dart 教程</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                文档
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/">开发者指南</a></li>
                <li><a href="http://api.dartlang.org">API 参考</a></li>
                <li><a href="/docs/spec/">语言规范</a></li>

                <li class="divider"></li>
                <li><a href="/docs/dart-up-and-running/">Dart: Up and Running</a></li>
                <li><a href="/books/">更多图书</a></li>

                <li class="divider"></li>
                <li><a href="/articles/">文章</a></li>
                <li><a href="/support/faq.html">FAQ</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                       工具
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/dart-up-and-running/contents/ch04-tools-dart2js.html">dart2js</a>
                </li><li><a href="/tools/editor/">Dart Editor</a></li>
                <li><a href="http://pub.dartlang.org/">Pub Package Manager</a></li>
                <li><a href="/tools/">更多工具</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                     资源
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/samples/">示例代码</a></li>
                <li><a href="http://synonym.dartlang.org/">Translations from Dart</a></li>
                <li><a href="http://try.dartlang.org/">Try Dart!</a></li>

                <li class="divider"></li>
                <li><a href="/slides/">演示文稿</a></li>
                <li><a href="/dart-tips/">Dart 技巧视频</a></li>

                <li class="divider"></li>
                <li><a href="http://code.google.com/p/dart/issues/list">Bugs and Feature Requests</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                              社区
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/support/">支持和社区资源</a></li>
                <li><a href="http://code.google.com/p/dart/wiki/Contributing">Contributor's Guide</a></li>
              </ul>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li>
              <form class="navbar-search" action="/search.html" id="cse-search-box">
                <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
                <input type="hidden" name="ie" value="UTF-8">
                <input type="hidden" name="hl" value="en">
                <input type="search" name="q" class="search-query placeholder-position-fix form-control" id="q" autocomplete="off" placeholder="Search">
              </form>
            </li>
            <li><a href="https://twitter.com/dart_lang" class="btn"><i class="sprite-icon-social-twitter"></i></a></li>
            <li><a href="https://plus.google.com/+dartlang/posts" class="btn"><i class="sprite-icon-social-gplus"></i></a></li>
          </ul>
        </div><!-- /.nav-collapse -->

      </div><!-- /.container -->
    </div><!-- /.navbar -->

  


<div class="container-page">
  <div class="container">
  	<div class="container sub-page">
      <div class="row">
        <article class="has-permalinks"><div class="col-md-3">
  <div class="bs-sidebar hidden-print affix-top" role="complementary">

<ol class="toc nav bs-sidenav" id="markdown-toc">
  <li><a href="#the-dart-vm-and-the-event-loop">The Dart VM and the event loop</a></li>
  <li><a href="#file-system-access">File system access</a></li>
  <li><a href="#interacting-with-processes">Interacting with processes</a></li>
  <li><a href="#writing-web-servers">Writing web servers</a></li>
  <li><a href="#feature-requests-welcome">Feature requests welcome</a></li>
</ol>

  </div>
</div>
<div class="col-md-7">
  <p><!-- Start of content -->
	</p>

  <h1 id="an-introduction-to-the-dartio-library">An Introduction to the dart:io Library</h1>

  <p><em>Written by Mads Ager <br />
March 2012 (updated October 2012 and February 2013)</em></p>

  <p>The <a href="http://api.dartlang.org/io.html">dart:io</a> library
is aimed at server-side code
that runs on the standalone Dart VM.
In this article we will give you a feel for
what is currently possible with dart:io
by going through a couple of examples.</p>

  <p>Dart is a single-threaded programming language.
If an operation blocks the Dart thread,
the application will make no progress before that operation completes.
For scalability it is therefore crucial that no I/O operations block.
Instead of blocking on I/O operations,
dart:io uses an asynchronous programming model inspired by
<a href="http://nodejs.org">node.js</a>,
<a href="https://github.com/eventmachine/eventmachine/wiki">EventMachine</a>, and
<a href="http://twistedmatrix.com/trac/">Twisted</a>.</p>

  <h2 id="the-dart-vm-and-the-event-loop">The Dart VM and the event loop</h2>

  <p>Before we dive into asynchronous I/O operations,
it might be useful to explain how the standalone Dart VM operates.</p>

  <p>When executing a server-side application,
the Dart VM runs in an event loop with
an associated event queue of pending asynchronous operations.
The VM terminates when it has executed the current code to completion
and no more pending operations are in the queue.</p>

  <p>One simple way to add an event to the event queue is to
schedule a function to be called in the future.
You can do this by creating a
<a href="http://api.dartlang.org/dart_async/Timer.html">Timer</a> object.
The following example registers a timer with the event queue
and then drops off the end of main().
Because a pending operation is in the event queue,
the VM does not terminate at that point.
After one second,
the timer fires and the code in the argument callback executes.
Once that code executes to completion,
no more pending operations are in the event queue
and the VM terminates.</p>

  <!--- BEGIN(io_timer) -->
  <pre class="prettyprint lang-dart">import 'dart:async';

main() {
  new Timer(new Duration(seconds:1), () =&gt; print('timer'));
  print('end of main');
}</pre>
  <!--- END(io_timer) -->

  <p>Running this example at the command line, we get:</p>

  <pre><code>$ dart timer.dart 
end of main
timer
</code></pre>

  <p>Had we made the timer repeating by using the Timer.periodic() constructor,
the VM would not terminate
and would continue to print out ‘timer’ every second.</p>

  <h2 id="file-system-access">File system access</h2>

  <p>The dart:io library provides access to files and directories through the
<a href="http://api.dartlang.org/io/File.html">File</a> and
<a href="http://api.dartlang.org/io/Directory.html">Directory</a> classes.</p>

  <p>The following example prints its own source code.
To determine the location of the source code being executed,
we use the
<a href="http://api.dartlang.org/docs/releases/latest/dart_io/Platform.html">Platform</a>
class.</p>

  <!--- BEGIN(io_file_system) -->
  <pre class="prettyprint lang-dart">import 'dart:io';
import 'dart:async';

main() {
  var file = new File(Platform.script.toFilePath());
  Future&lt;String&gt; finishedReading = file.readAsString(encoding: Encoding.ASCII);
  finishedReading.then((text) =&gt; print(text));
}</pre>
  <!--- END(io_file_system) -->

  <p>Notice that the readAsString() method is asynchronous;
it returns a <a href="http://api.dartlang.org/dart_async/Future.html">Future</a>
that will return the contents of the file
once the file has been read from the underlying system.
This asynchronicity allows the Dart thread to perform other work
while waiting for the I/O operation to complete.</p>

  <p>To illustrate more detailed file operations,
let’s change the example to read the contents
only up to the first semicolon and then to print that.
You could do this in two ways:
either open the file for random access,
or open an
<a href="http://api.dartlang.org/io/InputStream.html">InputStream</a>
for the file and stream in the data.</p>

  <p>Here is a version that opens the file for random access operations.
The code opens the file for reading and then reads one byte at a time
until it encounters the char code for ‘;’.</p>

  <!--- BEGIN(io_random_access) -->
  <pre class="prettyprint lang-dart">import 'dart:io';

main() {
  var semicolon = ';'.codeUnitAt(0);
  var result = [];

  new File(Platform.script.toFilePath()).open(mode: FileMode.READ).then((RandomAccessFile file) {
    // Callback to deal with each byte.
    void onByte(int byte) {
      result.add(byte);
      if (byte == semicolon) {
        print(new String.fromCharCodes(result));
        file.close();
      } else {
        file.readByte().then(onByte);
      }
    }
    file.readByte().then(onByte);
  });
}</pre>
  <!--- END(io_random_access) -->

  <p>When you see a use of <code>then()</code>, you are seeing a Future in action.
Both the <code>open()</code> and <code>readByte()</code> methods return a Future object.</p>

  <p>This code is, of course,
a very simple use of random-access operations.
Operations are available for writing,
seeking to a given position, truncating, and so on.</p>

  <p>Let’s implement a version using a stream.
The following code opens the file for reading presenting the content
as a stream of lists of bytes. Like all streams in Dart you listen on
this stream and the data is given in chunks. You can always stop
reading more from the file by cancelling the subscription.</p>

  <!--- BEGIN(io_stream) -->
  <pre class="prettyprint lang-dart">import 'dart:io';
import 'dart:async';

main() {
  List result = [];

  Stream&lt;List&lt;int&gt;&gt; stream = new File(Platform.script.toFilePath()).openRead();
  int semicolon = ';'.codeUnitAt(0);
  StreamSubscription subscription;
  subscription = stream.listen((data) {
    for (int i = 0; i &lt; data.length; i++) {
      result.add(data[i]);
      if (data[i] == semicolon) {
        print(new String.fromCharCodes(result));
        subscription.cancel();
        return;
      }
    }
  });
}</pre>
  <!--- END(io_stream) -->

  <p>[Stream&lt;List<int>&gt;] is used in multiple places in dart:io:
when working with stdin, files, sockets, HTTP connections, and so on.
Similarly, [IOSink](http://api.dartlang.org/dart_io/IOSink.html)s
are used to stream data to
stdout, files, sockets, HTTP connections, and so on.</int></p>

  <h2 id="interacting-with-processes">Interacting with processes</h2>

  <p>For the simple case, use
<a href="http://api.dartlang.org/dart_io/Process.html#run">Process.run()</a>
to run a process
and collect its output. Use <code>run()</code> when you don’t
need interactive control over the process.</p>

  <!--- BEGIN(io_process) -->
  <pre class="prettyprint lang-dart">import 'dart:io';

main() {
  // List all files in the current directory,
  // in UNIX-like operating systems.
  Process.run('ls', ['-l']).then((ProcessResult results) {
    print(results.stdout);
  });
}</pre>
  <!--- END(io_process) -->

  <p>You can also start a process by creating a
<a href="http://api.dartlang.org/dart_io/Process.html">Process</a> object
using the Process.start() constructor.
Once you have a Process object you can interact with the process
by writing data to its stdin sink,
reading data from its stderr and stdout streams,
and killing the process.
When the process exits the exitCode future completes with
the exit code of the process.</p>

  <p>The following example runs ‘ls -l’ in a separate process
and prints the output and the exit code for the process to stdout.
Since we are interested in getting lines,
we use a
<a href="http://api.dartlang.org/dart_convert/Utf8Decoder.html">Utf8Decoder</a>,
which decodes chunks of bytes into strings followed by a
<a href="http://api.dartlang.org/dart_convert/LineSplitter.html">LineSplitter</a>,
which splits the strings at line boundaries.</p>

  <!--- BEGIN(io_process_transform) -->
  <pre class="prettyprint lang-dart">import 'dart:io';
import 'dart:convert';

main() {
  Process.start('ls', ['-l']).then((process) {
    process.stdout.transform(new Utf8Decoder())
                  .transform(new LineSplitter())
                  .listen((String line) =&gt; print(line));
    process.stderr.listen((data) { });
    process.exitCode.then((exitCode) {
      print('exit code: $exitCode');
    });
  });
}</pre>
  <!--- END(io_process_transform) -->

  <p>Notice that exitCode can complete before all of the lines of output
have been processed. Also note
that we do not explicitly close the process. In order to
not leak resources we have to drain both the stderr and the stdout
streams. To do that we set a listener to drain the stderr stream.</p>

  <p>Instead of printing the output to stdout,
we can use the streaming classes
to pipe the output of the process to a file.</p>

  <!--- BEGIN(io_process_stdio) -->
  <pre class="prettyprint lang-dart">import 'dart:io';

main() {
  var output = new File('output.txt').openWrite();
  Process.start('ls', ['-l']).then((process) {
    process.stdout.pipe(output);
    process.stderr.listen((data) { });
    process.exitCode.then((exitCode) {
        print('exit code: $exitCode');
    });
  });
}</pre>
  <!--- END(io_process_stdio) -->

  <h2 id="writing-web-servers">Writing web servers</h2>

  <p>dart:io makes it easy to write HTTP servers and clients.
To write a simple web server,
all you have to do is create an
<a href="http://api.dartlang.org/dart_io/HttpServer.html">HttpServer</a>
and hook up a listener to its stream of <code>HttpRequest</code>s.</p>

  <p>Here is a simple web server
that just answers ‘Hello, world’ to any request.</p>

  <!--- BEGIN(io_http_server) -->
  <pre class="prettyprint lang-dart">import 'dart:io';

main() {
  HttpServer.bind('127.0.0.1', 8080).then((server) {
    server.listen((HttpRequest request) {
      request.response.write('Hello, world');
      request.response.close();
    });
  });
}</pre>
  <!--- END(io_http_server) -->

  <p>Running this application
and pointing your browser to ‘http://127.0.0.1:8080’
gives you ‘Hello, world’ as expected.</p>

  <p>Let’s add a bit more and actually serve files.
The base path for every file that we serve will be
the location of the script.
If no path is specified in a request we will serve index.html.
For a request with a path,
we will attempt to find the file and serve it.
If the file is not found we will respond with a ‘404 Not Found’ status.
We make use of the streaming interface
to pipe all the data read from a file directly to the response stream.</p>

  <!--- BEGIN(io_http_server_file) -->
  <pre class="prettyprint lang-dart">import 'dart:io';

_sendNotFound(HttpResponse response) {
  response.statusCode = HttpStatus.NOT_FOUND;
  response.close();
}

startServer(String basePath) {
  HttpServer.bind('127.0.0.1', 8080).then((server) {
    server.listen((HttpRequest request) {
      final Path path = new Path(request.uri.path).canonicalize();
      if (!path.isAbsolute) {
        _sendNotFound(request.response);
        return;
      }
      // PENDING: Do more security checks here?
      final String stringPath =
          path.toString() == '/' ? '/index.html' : path.toString();
      final File file = new File('${basePath}${stringPath}');
      file.exists().then((bool found) {
        if (found) {
          file.openRead()
              .pipe(request.response)
              .catchError((e) { });
        } else {
          _sendNotFound(request.response);
        }
      });
    });
  });
}

main() {
  // Compute base path for the request based on the location of the
  // script and then start the server.
  File script = new File(Platform.script.toFilePath());
  startServer(script.directory.path);
}</pre>
  <!--- END(io_http_server_file) -->

  <p>Writing HTTP clients is very similar to using the
<a href="http://api.dartlang.org/dart_io/HttpClient.html">HttpClient</a>
class.</p>

  <h2 id="feature-requests-welcome">Feature requests welcome</h2>

  <p>The dart:io library is already capable of performing a lot of tasks.
As an example of our own use of dart:io,
we have rewritten the Dart testing scripts from Python to Dart.
All of the tests that you see being run on the
<a href="http://build.chromium.org/p/client.dart">buildbot</a>
are running on the Dart VM using the dart:io library!</p>

  <p>Please give dart:io a spin and let us know what you think.
Feature requests are very welcome!
When you file a bug or feature request,
use the Area-IO label in the issue tracker at
<a href="http://dartbug.com">dartbug.com</a>.</p>
</div>

    	  </div> <!-- End of content from toc.html -->
        </article>
	  </div>

	
	<ul class="pager">
	  <li><a href="/articles/">More articles about Dart <i class="glyphicon glyphicon-chevron-up"></i></a></li>
	 </ul>
	 

	</div>
  </div>
</div>


  <footer class="footer container-full">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h3>一种用于创建可扩展 web 应用程序的语言、工具和代码库</h3>
          <p>Dart 是一个 <a href="https://code.google.com/p/dart/">开源项目</a>，由  Google 和其他人员参与。</p>
          <p class="sm">除非注明，该页面内容使用 the Creative Commons Attribution 3.0 License 发布，示例代码使用  BSD License 发布。</p>
          <!-- 
          <p><a class="saelogo" href="http://sae.sina.com.cn/activity/invite/15649/weibo" target="_blank"><img src="http://static.sae.sina.com.cn/image/poweredby/poweredby.png" title="Powered by Sina App Engine"></a></p>     	
          -->
        </div>
        <div class="col-md-2 col-md-offset-1">
          <h4>受欢迎的文章</h4>
          <ul>
            <li><a href="/polymer-dart/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Polymer.dart</a></li>
            <li><a href="/performance/">性能</a></li>
            <li><a href="/docs/dart-up-and-running/contents/ch02.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">语言概览</a> &amp;
            <a href="/docs/dart-up-and-running/contents/ch03.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码库概览</a></li>
            <li><a href="/samples/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">示例代码</a></li>
            <li><a href="/docs/tutorials/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">教程</a> &amp;
                <a href="/codelabs/darrrt/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码实验室</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>资源</h4>
          <ul>
            <li><a href="http://pub.dartlang.org/">Pub packages</a></li>
            <li><a href="http://synonym.dartlang.org/">Translations from Dart</a></li>
            <li><a href="http://code.google.com/p/dart/issues/list">Dart bugs and feature requests</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>社区</h4>
          <ul>
            <li><a href="/support/">邮件列表</a></li>
            <li><a href="http://bbs.dartlang.cc">中文社区</a></li>
            <li><a href="https://plus.google.com/communities/114566943291919232850">G+ 社区</a></li>
            <li><a href="https://plus.google.com/+dartlang/posts">G+ 新闻发布频道</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/dart">Stack Overflow</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer> <!-- End footer -->

<script type='text/javascript' src='/js/jquery.js'></script>
<script type='text/javascript' src='/js/bootstrap.min.js'></script>
<script type='text/javascript' src='/js/social-event-analytics.js'></script>
<script type='text/javascript' src='/js/prettify.js'></script>
<script type='text/javascript' src='/js/lang-dart.js'></script>
<script type='text/javascript' src='/js/lang-yaml.js'></script>
<script type='text/javascript' src='/js/scripts.js'></script>




</body>
</html>

