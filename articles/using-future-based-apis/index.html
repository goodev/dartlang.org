<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Product" xmlns:wb="http://open.weibo.com/wb">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <title>Using Future Based APIs | Dart: 用于创建结构化的web应用</title>
  <meta property="wb:webmaster" content="a984f6440858ee44" />
  <meta property="twitter:account_id" content="376585411" />
  <meta itemprop="name" content="Using Future Based APIs | Dart: 用于创建结构化的web应用">
  
  <meta itemprop="image" content="https://www.dartlang.org/imgs/dart-logo-900w.png">
  
  <meta itemprop="description" content="A first look at Futures and how to use them to make your asynchronous code better.">

  <!-- Bootstrap core CSS -->
  <link href="/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/css/dart-style.css" rel="stylesheet">
  <link href="/css/prettify.css" type="text/css" rel="stylesheet" />
  <link href="//fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
  <link href="//fonts.googleapis.com/css?family=Roboto:300,400" rel="stylesheet">
	
	<link rel="author" href="/authors/shailen-tuli.html">
	
	<link rel="alternate" type="application/atom+xml" href="http://dartnews.sinaapp.com/?feed=atom" title="Atom feed">
  <!-- 
  <link href="https://plus.google.com/109866369054280216564" rel="publisher">
  -->
  <link href="http://weibo.com/cndart" rel="publisher">

  <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
    <script src="js/html5shiv.js"></script>
    <script src="js/respond.min.js"></script>
  <![endif]-->

  <!-- 
<script type="text/javascript">

  //var _gaq = _gaq || [];
 // _gaq.push(['_setAccount', 'UA-26406144-4']);
  //_gaq.push(['_setDomainName', 'dartlang.org']);
  //_gaq.push(['_setSiteSpeedSampleRate', 50]);
  //_gaq.push(['_trackPageview']);

 // (function() {
   // var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   // ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   // var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 // })();

</script>
-->


  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script>
  

<!-- 
	window.___gcfg = {lang: 'en'};
	(function()
	{var po = document.createElement("script");
	po.type = "text/javascript"; po.async = true;po.src = "https://apis.google.com/js/plusone.js";
	var s = document.getElementsByTagName("script")[0];
	s.parentNode.insertBefore(po, s);
	})();
-->
  </script>
<!-- 
  <script>
    window.twttr = (function (d,s,id) {
      var t, js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return; js=d.createElement(s); js.id=id;
      js.src="//platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs);
      return window.twttr || (t = { _e: [], ready: function(f){ t._e.push(f) } });
    }(document, "script", "twitter-wjs"));
  </script>
-->
  <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
</head>
<body onload="prettyPrint()">
    <div class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/"><i class="sprite-icon-dart-logo"></i></a>
        </div>

        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
           <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                       入门
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/codelabs/darrrt/">试试 Dart</a></li>
                <li><a href="/docs/tutorials/">Dart 教程</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                文档
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/">开发者指南</a></li>
                <li><a href="http://api.dartlang.org">API 参考</a></li>
                <li><a href="/docs/spec/">语言规范</a></li>

                <li class="divider"></li>
                <li><a href="/docs/dart-up-and-running/">Dart: Up and Running</a></li>
                <li><a href="/books/">更多图书</a></li>

                <li class="divider"></li>
                <li><a href="/articles/">文章</a></li>
                <li><a href="/support/faq.html">FAQ</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                       工具
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/docs/dart-up-and-running/contents/ch04-tools-dart2js.html">dart2js</a>
                </li><li><a href="/tools/editor/">Dart Editor</a></li>
                <li><a href="http://pub.dartlang.org/">Pub Package Manager</a></li>
                <li><a href="/tools/">更多工具</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                                     资源
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/samples/">示例代码</a></li>
                <li><a href="http://synonym.dartlang.org/">Translations from Dart</a></li>
                <li><a href="http://try.dartlang.org/">Try Dart!</a></li>

                <li class="divider"></li>
                <li><a href="/slides/">演示文稿</a></li>
                <li><a href="/dart-tips/">Dart 短视频</a></li>

                <li class="divider"></li>
                <li><a href="http://code.google.com/p/dart/issues/list">Bugs and Feature Requests</a></li>
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                              社区
              </a>
              <ul class="dropdown-menu">
                <i class="sprite-icon-dd-tip"></i>
                <li><a href="/support/">支持和社区资源</a></li>
                <li><a href="http://code.google.com/p/dart/wiki/Contributing">Contributor's Guide</a></li>
              </ul>
            </li>
          </ul>

          <ul class="nav navbar-nav navbar-right">
            <li>
              <form class="navbar-search" action="/search.html" id="cse-search-box">
                <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
                <input type="hidden" name="ie" value="UTF-8">
                <input type="hidden" name="hl" value="en">
                <input type="search" name="q" class="search-query placeholder-position-fix form-control" id="q" autocomplete="off" placeholder="Search">
              </form>
            </li>
            <li><a target="_blank" href="https://twitter.com/dart_lang" class="btn"><i class="sprite-icon-social-twitter"></i></a></li>
            <li><a target="_blank" href="https://plus.google.com/+dartlang/posts" class="btn"><i class="sprite-icon-social-gplus"></i></a></li>
            <li><a target="_blank" href="http://weibo.com/cndart" class="btn"><i class="sprite-icon-social-weibo"><img src="/imgs/weibo.png"></i></a></li>
          </ul>
        </div><!-- /.nav-collapse -->

      </div><!-- /.container -->
    </div><!-- /.navbar -->

  


<div class="container-page">
  <div class="container">
  	<div class="container sub-page">
      <div class="row">
        <article class="has-permalinks"><div class="col-md-3">
  <div class="bs-sidebar hidden-print affix-top" role="complementary">

<ol class="toc nav bs-sidenav" id="markdown-toc">
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#what-is-a-future">What is a Future?</a></li>
  <li><a href="#using-a-future">Using a Future</a></li>
  <li><a href="#sequence-of-events-during-code-execution">Sequence of events during code execution</a></li>
  <li><a href="#handling-errors-when-dealing-with-futures">Handling errors when dealing with Futures</a></li>
  <li><a href="#calling-multiple-functions-that-return-futures">Calling multiple functions that return Futures</a>    <ol>
      <li><a href="#chaining-function-calls-using-then">Chaining function calls using then()</a></li>
      <li><a href="#waiting-on-multiple-futures-to-complete-using-futurewait">Waiting on multiple Futures to complete using Future.wait()</a></li>
    </ol>
  </li>
  <li><a href="#more-information">More information</a></li>
</ol>

  </div>
</div>
<div class="col-md-7">
  <p><!-- Start of content -->
	</p>

  <h1 id="using-future-based-apis">Using Future Based APIs</h1>

  <p><em>Written by Shailen Tuli, February 2013</em></p>

  <h2 id="introduction">Introduction</h2>

  <p>Dart is a single-threaded programming language. If any code blocks the thread
of execution, the program effectively freezes. Let’s look at some code where
this happens:</p>

  <pre class="prettyprint lang-dart">import 'dart:io';

void printDailyNewsDigest() {
  File file = new File(&quot;dailyNewsDigest.txt&quot;);
  print(file.readAsStringSync());
}

void main() {
  printDailyNewsDigest();
  printWinningLotteryNumbers();
  printWeatherForecast();
  printBaseballScore();
}</pre>

  <p>Our program reads the news of the day from a file, <code>dailyNewsDigest.txt</code>,
prints it, and then prints a bunch of other items of interest to the user:</p>

  <pre><code>&lt;Contents of dailyNewsDigest.txt&gt;
Winning lotto numbers: [23, 63, 87, 26, 2]
Tomorrow's forecast: 70F, sunny.
Baseball score: Red Sox 10, Yankees 0
</code></pre>

  <p>Our code is problematic: since <code>readAsStringSync()</code> blocks, the remaining code
runs only when <code>readAsStringSync()</code> returns with the contents of the file, 
<em>however long that takes</em>.  And if reading the file takes a long time, the
user waits passively, wondering if she won the lottery, what tomorrow’s weather
will be like, and who won today’s game. Not good.</p>

  <p>To help keep the application responsive, Dart library authors use an
asynchronous model when defining functions that do potentially expensive work.
Such functions return their value using a Future.</p>

  <h2 id="what-is-a-future">What is a Future?</h2>

  <p>A Future represents a means for getting a value sometime in the future. When a
function that returns a Future is invoked, two things happen:</p>

  <ol>
    <li>The function queues up work to be done and returns an uncompleted Future
object immediately.</li>
    <li>Later, when a value is available, the Future object completes with that
value (or with an error; we’ll discuss that later).</li>
  </ol>

  <p>To get the value that the Future represents, use the <code>then()</code> method to
register a callback. This callback fires when the Future completes.</p>

  <h2 id="using-a-future">Using a Future</h2>

  <p>Let’s rewrite <code>printDailyNewsDigest()</code> to get the file contents
asynchronously:</p>

  <pre class="prettyprint lang-dart">import 'dart:io';
import 'dart:async';

void printDailyNewsDigest() {
  File file = new File(&quot;dailyNewsDigest.txt&quot;);
  Future future = file.readAsString();
  future.then((content) {
    print(content);
  });
}</pre>

  <p>The <code>printDailyNewsDigest()</code> function now uses <code>readAsString()</code>, which is
non-blocking. Calling <code>readAsString()</code> queues up the work to be done but
doesn’t stop the rest of the code from executing. The program prints the
lottery numbers, the forecast, and the baseball score; when
<code>readAsString()</code> finishes reading the news file, the program prints its
contents. If <code>readAsString()</code> takes a little while to complete its work, no
great harm is done: the user gets to read other things before the daily news
digest is printed.</p>

  <pre><code>Winning lotto numbers: [23, 63, 87, 26, 2]
Tomorrow's forecast: 70F, sunny.
Baseball score: Red Sox 10, Yankees 0
&lt;Contents of dailyNewsDigest.txt&gt;
</code></pre>

  <h2 id="sequence-of-events-during-code-execution">Sequence of events during code execution</h2>

  <p>The preceding code executes in three steps:</p>

  <ol>
    <li>The program enters <code>main()</code>, which calls <code>printDailyNewsDigest()</code>, which
queues up the file reading task.  After calling the remaining print functions,
<code>main()</code> exits, but the program continues.</li>
    <li>The work scheduled by <code>readAsString()</code> is performed, and the contents of the
file are read into memory. When the entire file is read, the Future completes
with the file contents.</li>
    <li>The callback registered within <code>then()</code> fires and prints the contents
of the news file.</li>
  </ol>

  <p>Calling <code>then()</code> returns a new Future, which completes with the value
returned by <code>then()</code>’s callback. This means that calls to <code>then()</code> can be
chained (we’ll see examples of this later). </p>

  <h2 id="handling-errors-when-dealing-with-futures">Handling errors when dealing with Futures</h2>

  <p>If a Future-returning function completes with an error, the Future returned by
<code>then()</code> also completes with an error. We can capture that error using
<code>catchError()</code>:</p>

  <pre class="prettyprint lang-dart">void printDailyNewsDigest() {
  File file = new File(&quot;dailyNewsDigest.txt&quot;);
  Future future = file.readAsString();
  future.then((content) =&gt; doSomethingWith(content))
        .catchError((e) =&gt; handleError(e));
}</pre>

  <p>If <code>dailyNewsDigest.txt</code> doesn’t exist or isn’t available for reading,
the code above executes as follows:</p>

  <ol>
    <li><code>readAsString()</code>’s Future completes with an error.</li>
    <li><code>then()</code>’s Future completes with an error.</li>
    <li><code>catchError()</code>’s callback handles the error, <code>catchError()</code>’s Future
completes normally, and the error does not propagate.</li>
  </ol>

  <aside class="alert alert-info">
    <p>Chaining catchError() to then() is a common pattern when working with
  functions that return Futures.
  <strong>
    Consider this pairing the asynchronous equivalent of try-catch blocks.
  </strong></p>
  </aside>

  <p>Like <code>then()</code>, <code>catchError()</code> returns a new Future that completes with
the return value of its callback.</p>

  <p>For more details and examples, read
<a href="/articles/futures-and-error-handling/">Futures and Error Handling</a>.</p>

  <h2 id="calling-multiple-functions-that-return-futures">Calling multiple functions that return Futures</h2>

  <p>Consider three functions,  <code>expensiveA()</code>, <code>expensiveB()</code>, and <code>expensiveC()</code>,
that return Futures.  You can invoke them sequentially (one function starts
when a previous one completes), or you can kick off all of them at the same
time and do something once all the values return. The Future interface
is fluid enough to deal with both use cases.</p>

  <h3 id="chaining-function-calls-using-then">Chaining function calls using then()</h3>

  <p>When Future-returning functions need to run in order, use
chained <code>then()</code> calls:</p>

  <pre class="prettyprint lang-dart">expensiveA().then((aValue) =&gt; expensiveB()) 
            .then((bValue) =&gt; expensiveC()) 
            .then((cValue) =&gt; doSomethingWith(cValue));</pre>

  <p>Nested callbacks also work, but they’re harder to read and not as Dart-y.</p>

  <h3 id="waiting-on-multiple-futures-to-complete-using-futurewait">Waiting on multiple Futures to complete using Future.wait()</h3>

  <p>If the order of execution of the functions is not important, 
you can use <code>Future.wait()</code> to handle multiple Future objects
without having to explicitly chain function calls.</p>

  <p>The functions get triggered in quick succession; when all of them
complete with a value, <code>Future.wait()</code> returns a new Future.
This Future completes with a list containing the values produced by
each function.</p>

  <pre class="prettyprint lang-dart">Future.wait([expensiveA(), expensiveB(), expensiveC()])
      .then((List responses) =&gt; chooseBestResponse(responses))
      .catchError((e) =&gt; handleError(e));</pre>

  <p>If any of the invoked functions completes with an error, the Future returned
by <code>Future.wait()</code> also completes with an error. Use <code>catchError()</code> to handle
the error.</p>

  <h2 id="more-information">More information</h2>

  <p>Read the following documentation for more details on using Futures:</p>

  <ul>
    <li><a href="/articles/futures-and-error-handling/">Futures and Error Handling</a>,
an article that starts where this one ends</li>
    <li><a href="/articles/event-loop/">The Event Loop and Dart</a>,
an article that describes how to schedule tasks using Futures</li>
    <li><a href="http://api.dartlang.org/dart_async/Future.html">Future API reference</a></li>
  </ul>

</div>

    	  </div> <!-- End of content from toc.html -->
        </article>
	  </div>

	
	<ul class="pager">
	  <li><a href="/articles/">关于 Dart 的更多文章 <i class="glyphicon glyphicon-chevron-up"></i></a></li>
	 </ul>
	 

	</div>
  </div>
</div>

  <footer class="footer container-full">
    <div class="container">
      <div class="row">
        <div class="col-md-5">
          <h3>一种用于创建可扩展 web 应用程序的语言、工具和代码库</h3>
          <p>Dart 是一个 <a href="https://code.google.com/p/dart/">开源项目</a>，由  Google 和其他人员参与。</p>
          <p class="sm">除非注明，该页面内容使用 the Creative Commons Attribution 3.0 License 发布，示例代码使用  BSD License 发布。</p>
          <!-- 
          <p><a class="saelogo" href="http://sae.sina.com.cn/activity/invite/15649/weibo" target="_blank"><img src="http://static.sae.sina.com.cn/image/poweredby/poweredby.png" title="Powered by Sina App Engine"></a></p>     	
          -->
        </div>
        <div class="col-md-2 col-md-offset-1">
          <h4>受欢迎的文章</h4>
          <ul>
            <li><a href="/polymer-dart/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">Polymer.dart</a></li>
            <li><a href="/performance/">性能</a></li>
            <li><a href="/docs/dart-up-and-running/contents/ch02.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">语言概览</a> &amp;
            <a href="/docs/dart-up-and-running/contents/ch03.html?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码库概览</a></li>
            <li><a href="/samples/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">示例代码</a></li>
            <li><a href="/docs/tutorials/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">教程</a> &amp;
                <a href="/codelabs/darrrt/?utm_source=site&amp;utm_medium=footer&amp;utm_campaign=homepage">代码实验室</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>资源</h4>
          <ul>
            <li><a href="http://pub.dartlang.org/">Pub packages</a></li>
            <li><a href="http://synonym.dartlang.org/">Translations from Dart</a></li>
            <li><a href="http://code.google.com/p/dart/issues/list">Dart bugs and feature requests</a></li>
          </ul>
        </div>
        <div class="col-md-2">
          <h4>社区</h4>
          <ul>
            <li><a href="/support/">邮件列表</a></li>
            <li><a href="http://bbs.dartlang.cc">中文社区</a></li>
            <li><a href="https://plus.google.com/communities/114566943291919232850">G+ 社区</a></li>
            <li><a href="https://plus.google.com/+dartlang/posts">G+ 新闻发布频道</a></li>
            <li><a href="http://stackoverflow.com/questions/tagged/dart">Stack Overflow</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer> <!-- End footer -->

<script type='text/javascript' src='/js/jquery.js'></script>
<script type='text/javascript' src='/js/bootstrap.min.js'></script>
<script type='text/javascript' src='/js/social-event-analytics.js'></script>
<script type='text/javascript' src='/js/prettify.js'></script>
<script type='text/javascript' src='/js/lang-dart.js'></script>
<script type='text/javascript' src='/js/lang-yaml.js'></script>
<script type='text/javascript' src='/js/scripts.js'></script>




<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F76b2695e71e6cec6e6af036d76afa367' type='text/javascript'%3E%3C/script%3E"));
</script>

<!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=slide&amp;img=1&amp;pos=left&amp;uid=590574" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
var bds_config={"bdTop":367};
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);
</script>
<!-- Baidu Button END -->
</body>
</html>

